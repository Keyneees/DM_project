db.createView("driver_detailed", "drivers", [{ $lookup: { from: "driver_standings", localField: "driverId", foreignField: "driverId", as: "standings" } }, { $project: { _id: 0, driverId: 1, number: 1, code: 1, forename: 1, surname: 1, dob: 1, nationality: 1, "standings.raceId": 1, "standings.points": 1, "standings.position": 1, "standings.wins": 1 } }] )
db.driver_detailed.aggregate([{$lookup: {from: "races", localField: "standings.raceId", foreignField: "raceId", as: "races_info"}}, {$addFields: {standings: {$map: {input: "$standings", as: "s", in: {raceId: "$$s.raceId", points: "$$s.points", position: "$$s.position", wins: "$$s.wins", name: {$first: {$map: {input: {$filter: {input: "$races_info", as: "r", cond: {$eq: ["$$r.raceId", "$$s.raceId"]}}}, as: "race", in: "$$race.name"}}}, year: {$first: {$map: {input: {$filter: {input: "$races_info", as: "r", cond: {$eq: ["$$r.raceId", "$$s.raceId"]}}}, as: "race", in: "$$race.year"}}}, round: {$first: {$map: {input: {$filter: {input: "$races_info", as: "r", cond: {$eq: ["$$r.raceId", "$$s.raceId"]}}}, as: "race", in: "$$race.round"}}}}}}}}, {$project: {races_info: 0}}])
db.createView("drivers_detailed", "driver_detailed", [{$lookup: {from: "races", localField: "standings.raceId", foreignField: "raceId", as: "races_info"}}, {$addFields: {standings: {$map: {input: "$standings", as: "s", in: {raceId: "$$s.raceId", points: "$$s.points", position: "$$s.position", wins: "$$s.wins", name: {$first: {$map: {input: {$filter: {input: "$races_info", as: "r", cond: {$eq: ["$$r.raceId", "$$s.raceId"]}}}, as: "race", in: "$$race.name"}}}, year: {$first: {$map: {input: {$filter: {input: "$races_info", as: "r", cond: {$eq: ["$$r.raceId", "$$s.raceId"]}}}, as: "race", in: "$$race.year"}}}, round: {$first: {$map: {input: {$filter: {input: "$races_info", as: "r", cond: {$eq: ["$$r.raceId", "$$s.raceId"]}}}, as: "race", in: "$$race.round"}}}}}}}}, {$project: {races_info: 0}}])
db.drivers_detailed.aggregate({$unwind: "$standings"}, {$group: {_id: {driverId:"$driverId", surname: "$surname", year: "$standings.year"}, max_points: {$max: "$standings.points"}, rounds: {$max: "$standings.round"}}}, {$group: {_id: {driverId: "$_id.driverId", surname: "$_id.surname"}, seasons: {$push: {year: "$_id.year", points: "$max_points", races: "$rounds", average_points: {$divide: ["$max_points", "$rounds"]}}}}})
