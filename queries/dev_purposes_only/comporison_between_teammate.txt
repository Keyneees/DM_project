db.constructors.aggregate([{$lookup:{from:"results", let:{constructorId:"construcotId", driverId:"driverId", raceId:"raceId"}, pipeline:[{$match:{$expr:{["$constructorId", "$constructorId"]}}}, {$lookup:{from:"drivers", forignField:"driverId", localField:"driverId", as:"driver"}}, {$lookup:{from:"races", foreignField:"raceId", localField:"raceId", as:"season"}}, {$unwind:"$driver"}, {$unwind:"season"}, {$match:{"race.year":2021, name:"Ferrari"}}], as: "driver1_results"}}, {$lookup:{from:"results", let:{constructorId:"construcotId", driverId:"driverId", raceId:"raceId"}, pipeline:[{$match:{$expr:{["$constructorId", "$constructorId"]}}}, {$lookup:{from:"drivers", forignField:"driverId", localField:"driverId", as:"driver"}}, {$lookup:{from:"races", foreignField:"raceId", localField:"raceId", as:"season"}}, {$unwind:"$driver"}, {$unwind:"season"}, {$match:{"race.year":2021, name:"Ferrari"}}], as: "driver2_results"}}, {$match:{$expr:{$ne:["$driver1_results.driver.driverId", "$driver2_results.driver.driverId"]}}}, {$project:{_id:0, name:1, "driver1_results.driver.surname":1, "driver1_results.positionOrder":1, "driver2_results.driver.surname":1, "driver2_results.positionOrder":1}}])


//GIUSTO
db.constructors.aggregate([{ $match: { name: "Ferrari" } }, { $lookup: { from: "results", let: { constructorId: "$constructorId" }, pipeline: [ { $match: { $expr: { $eq: ["$constructorId", "$$constructorId"] } } }, { $lookup: { from: "races", localField: "raceId", foreignField: "raceId", as: "race" } }, { $unwind: "$race" }, { $match: { "race.year": 2021 } }, { $lookup: { from: "drivers", localField: "driverId", foreignField: "driverId", as: "driver" } }, { $unwind: "$driver" }, { $project: { driverId: "$driver.driverId", name: { $concat: ["$driver.forename", " ", "$driver.surname"] }, round: "$race.round", position: "$positionOrder", points: "$points" } } ], as: "seasonResults" } }, { $unwind: "$seasonResults" }, { $replaceRoot: { newRoot: { $mergeObjects: ["$$ROOT", "$seasonResults"] } } }, { $sort: { round: 1 } }, { $group: { _id: "$driverId", name: { $first: "$name" }, positions: { $push: "$position" }, points: { $push: "$points" } } }, { $group: { _id: null, drivers: { $push: { name: "$name", positions: "$positions", points: "$points" } } } }, { $project: { _id: 0, drivers: 1 } } ])
